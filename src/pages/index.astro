---
import BaseLayout from "../layouts/BaseLayout.astro";
import SearchBox from "../components/SearchBox.astro";
import TagList from "../components/TagList.astro";
import { getCollection } from "astro:content";

const base = import.meta.env.BASE_URL;

const stocks = await getCollection("stocks");
const psychology = await getCollection("psychology", ({ data }) => !data.draft);
const tech = await getCollection("tech");

const latestStocks = stocks
  .sort((a, b) => a.data.title.localeCompare(b.data.title, 'zh-TW'))
  .slice(0, 3);
const latestPsychology = psychology
  .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf())
  .slice(0, 3);
const latestTech = tech
  .sort((a, b) => a.data.order - b.data.order)
  .slice(0, 3);

const tagCounts = new Map();
for (const entry of [...stocks, ...psychology, ...tech]) {
  for (const tag of entry.data.tags ?? []) {
    tagCounts.set(tag, (tagCounts.get(tag) ?? 0) + 1);
  }
}
const topTags = [...tagCounts.entries()]
  .sort((a, b) => b[1] - a[1])
  .slice(0, 8)
  .map(([tag]) => tag);
---

<BaseLayout
  title="知識整合平台"
  description="股票分析、心理學洞察與技術文章的知識庫。"
>
  <section class="hero">
    <div>
      <p class="eyebrow">個人知識平台</p>
      <h1>投資、心理與技術的知識整合。</h1>
      <p class="lead">
        分享股票分析、心理學思考與技術探索，建立屬於自己的知識體系。
      </p>
      <div class="hero-actions">
        <a class="button" href={`${base}stocks/`}>股票分析</a>
        <a class="button ghost" href={`${base}psychology/`}>心理文章</a>
      </div>
      <div class="hero-stats">
        <div class="stat">
          <span class="stat-number">{stocks.length}</span>
          <span class="stat-label">股票</span>
        </div>
        <div class="stat">
          <span class="stat-number">{psychology.length}</span>
          <span class="stat-label">心理</span>
        </div>
        <div class="stat">
          <span class="stat-number">{tech.length}</span>
          <span class="stat-label">技術</span>
        </div>
      </div>
    </div>
    <aside class="hero-panel">
      <SearchBox />
      <div>
        <p class="panel-title">導覽地圖</p>
        <div class="nav-cards">
          <a class="nav-card" href={`${base}stocks/`}>
            <strong>📈 股票</strong>
            <span>個股分析、投資筆記與市場觀察。</span>
          </a>
          <a class="nav-card" href={`${base}psychology/`}>
            <strong>🧠 心理</strong>
            <span>心理學文章、人性洞察與自我成長。</span>
          </a>
          <a class="nav-card" href={`${base}tech/`}>
            <strong>💻 技術</strong>
            <span>程式開發、技術探索與學習筆記。</span>
          </a>
        </div>
      </div>
      <div>
        <p class="panel-title">熱門標籤</p>
        <TagList tags={topTags} />
      </div>
    </aside>
  </section>

  <section class="section">
    <h2 class="section-title">📈 最新股票分析</h2>
    <div class="section-grid">
      {latestStocks.map((stock) => (
        <article class="card">
          <p class="meta">{stock.data.category}</p>
          <h3><a href={`${base}stocks/${stock.slug}/`}>{stock.data.title}</a></h3>
          {stock.data.stockCode && <p class="stock-code-mini">{stock.data.stockCode}</p>}
          <TagList tags={stock.data.tags ?? []} />
        </article>
      ))}
    </div>
  </section>

  <section class="section">
    <h2 class="section-title">🧠 最新心理文章</h2>
    <div class="section-grid">
      {latestPsychology.map((post) => (
        <article class="card">
          <p class="meta">
            {post.data.date.toLocaleDateString("zh-TW", {
              year: "numeric",
              month: "short",
              day: "numeric",
            })}
          </p>
          <h3><a href={`${base}psychology/${post.slug}/`}>{post.data.title}</a></h3>
          <p>{post.data.description}</p>
          <TagList tags={post.data.tags ?? []} />
        </article>
      ))}
    </div>
  </section>

  <section class="section">
    <h2 class="section-title">💻 最新技術文章</h2>
    <div class="section-grid">
      {latestTech.map((entry) => (
        <article class="card">
          <p class="meta">第 {String(entry.data.order).padStart(2, "0")} 篇</p>
          <h3><a href={`${base}tech/${entry.slug}/`}>{entry.data.title}</a></h3>
          <TagList tags={entry.data.tags ?? []} />
        </article>
      ))}
    </div>
  </section>

  <section class="section">
    <h2 class="section-title">網站特色</h2>
    <div class="section-grid">
      <article class="card">
        <h3>📊 專業股票分析</h3>
        <p>個股深度分析、財務數據與投資策略，建立自己的投資知識庫。</p>
      </article>
      <article class="card">
        <h3>🧠 心理學洞察</h3>
        <p>人性探索、自我成長與心理學原理的深度思考。</p>
      </article>
      <article class="card">
        <h3>💻 技術分享</h3>
        <p>程式開發經驗、技術學習筆記與最佳實踐分享。</p>
      </article>
    </div>
  </section>
</BaseLayout>

<style>
  .stock-code-mini {
    font-family: 'Monaco', 'Courier New', monospace;
    font-size: 0.875rem;
    color: #6b7280;
    margin: 0.5rem 0;
  }
</style>
