---
import { getCollection } from "astro:content";
import BaseLayout from "../../layouts/BaseLayout.astro";
import TagList from "../../components/TagList.astro";
import { isVisible } from "../../lib/content";

export async function getStaticPaths() {
  const stocks = await getCollection("stocks", isVisible);
  return stocks.map((stock) => ({
    params: { slug: stock.slug },
    props: { stock },
  }));
}

const { stock } = Astro.props;
const { Content } = await stock.render();

const base = import.meta.env.BASE_URL;

const resolveCode = (data) => {
  if (data.stockCode) return data.stockCode;
  if (data.ticker && data.exchange) return `${data.ticker} ${data.exchange}`;
  return data.ticker ?? "";
};
const displayCode = resolveCode(stock.data);
const peValue = stock.data.peRatio ?? stock.data.pe;
const dividendValue = stock.data.dividendYield ?? stock.data.dividend;
const priceValue = stock.data.price;

const ratingColors = {
  '??': '#10b981',
  '??': '#10b981',
  '??': '#3b82f6',
  '??': '#f59e0b',
  '??': '#f59e0b',
  '??': '#ef4444',
  '??': '#ef4444'
};
---

<BaseLayout
  title={displayCode ? `${stock.data.title} (${displayCode}) - ????` : `${stock.data.title} - ????`}
  description={`${stock.data.title}ÁöÑÊäïË≥áÂàÜÊûê„ÄÅË≤°ÂãôÊï∏ÊìöËàáÂÄã‰∫∫ËßÄÈªû`}
  noindex={stock.data.internal ?? false}
>
  <article class="stock-detail">
    <!-- ËÇ°Á•®Ê®ôÈ°åÂçÄ -->
    <header class="stock-header">
      <div class="title-section">
        <h1>{stock.data.title}</h1>
        {displayCode && (
          <span class="stock-code-large">{displayCode}</span>
        )}
      </div>

      {stock.data.rating && (
        <span
          class="rating-badge-large"
          style={`background-color: ${ratingColors[stock.data.rating]}`}
        >
          {stock.data.rating}
        </span>
      )}
    </header>

    <!-- Âü∫Êú¨Ë≥áË®äÂç°Áâá -->
    <div class="info-cards">
      {priceValue && (
        <div class="info-card">
          <div class="card-label">ÂèÉËÄÉÂÉπÊ†º</div>
          <div class="card-value">${priceValue}</div>
        </div>
      )}
      {stock.data.targetPrice && (
        <div class="info-card">
          <div class="card-label">ÁõÆÊ®ôÂÉπ</div>
          <div class="card-value">${stock.data.targetPrice}</div>
          {priceValue && (
            <div class="card-hint">
              {((stock.data.targetPrice - priceValue) / priceValue * 100).toFixed(1)}% ÊΩõÂú®Á©∫Èñì
            </div>
          )}
        </div>
      )}
      {peValue && (
        <div class="info-card">
          <div class="card-label">Êú¨ÁõäÊØî</div>
          <div class="card-value">{peValue}</div>
        </div>
      )}
      {dividendValue && (
        <div class="info-card">
          <div class="card-label">ËÇ°ÊÅØÊÆñÂà©Áéá</div>
          <div class="card-value">{dividendValue}%</div>
        </div>
      )}
      {stock.data.marketCap && (
        <div class="info-card">
          <div class="card-label">Â∏ÇÂÄº</div>
          <div class="card-value">
            {(stock.data.marketCap / 1000000).toFixed(1)}ÂÖÜ
          </div>
        </div>
      )}
    </div>

    <!-- ÂàÜÈ°ûËàáÊ®ôÁ±§ -->
    <div class="meta-section">
      {stock.data.category && (
        <div class="category-badge">
          üìä {stock.data.category}
        </div>
      )}
      {stock.data.sector && (
        <div class="sector-badge">
          üè¢ {stock.data.sector}
        </div>
      )}
    </div>

    <TagList tags={stock.data.tags ?? []} />

    {stock.data.analysisDate && (
      <p class="analysis-date-large">
        üìÖ ÂàÜÊûêÊó•ÊúüÔºö{stock.data.analysisDate.toLocaleDateString('zh-TW', {
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        })}
      </p>
    )}

    <!-- ÊñáÁ´†ÂÖßÂÆπ -->
    <div class="content-body">
      <Content />
    </div>

    <!-- ËøîÂõûÈÄ£Áµê -->
    <nav class="back-nav">
      <a href={`${base}stocks/`} class="back-link">‚Üê ËøîÂõûËÇ°Á•®ÂàóË°®</a>
    </nav>
  </article>
</BaseLayout>

<style>
  .stock-detail {
    max-width: 800px;
    margin: 0 auto;
    padding: 2rem 1rem;
  }

  .stock-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 2rem;
    padding-bottom: 1.5rem;
    border-bottom: 2px solid var(--color-border, #e5e7eb);
  }

  .title-section h1 {
    margin: 0 0 0.5rem 0;
    font-size: 2.5rem;
    line-height: 1.2;
  }

  .stock-code-large {
    display: inline-block;
    font-size: 1.25rem;
    color: #6b7280;
    font-family: 'Monaco', 'Courier New', monospace;
    font-weight: 600;
  }

  .rating-badge-large {
    padding: 0.5rem 1.25rem;
    border-radius: 2rem;
    color: white;
    font-size: 1rem;
    font-weight: 700;
    white-space: nowrap;
  }

  .info-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
  }

  .info-card {
    background: var(--color-bg-secondary, #f9fafb);
    border: 1px solid var(--color-border, #e5e7eb);
    border-radius: 0.5rem;
    padding: 1rem;
    text-align: center;
  }

  .card-label {
    font-size: 0.75rem;
    color: #6b7280;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 0.5rem;
  }

  .card-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--color-text, #111827);
  }

  .card-hint {
    font-size: 0.75rem;
    color: #10b981;
    margin-top: 0.25rem;
  }

  .meta-section {
    display: flex;
    gap: 0.75rem;
    margin-bottom: 1rem;
    flex-wrap: wrap;
  }

  .category-badge,
  .sector-badge {
    padding: 0.5rem 1rem;
    background: var(--color-bg-secondary, #f3f4f6);
    border-radius: 0.375rem;
    font-size: 0.875rem;
    color: var(--color-text, #374151);
  }

  .analysis-date-large {
    font-size: 0.875rem;
    color: #6b7280;
    margin-bottom: 2rem;
  }

  .content-body {
    margin-top: 3rem;
    line-height: 1.8;
  }

  .content-body :global(h2) {
    margin-top: 2.5rem;
    margin-bottom: 1rem;
    font-size: 1.75rem;
    border-bottom: 2px solid var(--color-border, #e5e7eb);
    padding-bottom: 0.5rem;
  }

  .content-body :global(h3) {
    margin-top: 2rem;
    margin-bottom: 0.75rem;
    font-size: 1.35rem;
  }

  .content-body :global(ul),
  .content-body :global(ol) {
    margin-left: 1.5rem;
    margin-bottom: 1.5rem;
  }

  .content-body :global(li) {
    margin-bottom: 0.5rem;
  }

  .content-body :global(table) {
    width: 100%;
    border-collapse: collapse;
    margin: 1.5rem 0;
  }

  .content-body :global(th),
  .content-body :global(td) {
    border: 1px solid var(--color-border, #e5e7eb);
    padding: 0.75rem;
    text-align: left;
  }

  .content-body :global(th) {
    background: var(--color-bg-secondary, #f9fafb);
    font-weight: 600;
  }

  .content-body :global(blockquote) {
    border-left: 4px solid #3b82f6;
    padding-left: 1rem;
    margin: 1.5rem 0;
    color: #6b7280;
    font-style: italic;
  }

  .back-nav {
    margin-top: 4rem;
    padding-top: 2rem;
    border-top: 1px solid var(--color-border, #e5e7eb);
  }

  .back-link {
    color: #3b82f6;
    text-decoration: none;
    font-weight: 500;
    transition: color 0.2s;
  }

  .back-link:hover {
    color: #2563eb;
  }

  @media (max-width: 640px) {
    .stock-header {
      flex-direction: column;
      gap: 1rem;
    }

    .title-section h1 {
      font-size: 1.875rem;
    }

    .info-cards {
      grid-template-columns: repeat(2, 1fr);
    }
  }
</style>
